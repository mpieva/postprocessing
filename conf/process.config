def outdir = "reluctant_${manifest.version}"

process {

    //
    // Workflow: Splitbam
    //

    if(params.bam){
        withName: "SPLITBAM" {
            publishDir = [
                path:"split",
                mode:"copy",
                pattern:"*.{bam,txt}"
            ]
        }
    }
    withName: "ESTIMATE_CC" {
        publishDir = [
            path:"${outdir}",
            mode:"copy",
            pattern:"*.{txt}" ]
    }

    withName: "INDEX_STATS" {
        publishDir = [
            path:"${outdir}",
            mode:"copy",
            pattern:"*.{txt}" ]
    }

    //
    // Workflow: Bamfilter
    //

    withName: "ANALYZE_BAM" {
        publishDir = [
            path:"${outdir}/AnalyzeBAM_L35MQ25",
            mode:"copy",
            pattern:"*" ]
    }

    //
    // Deamination
    //

    withName:"BAM_DEAM_FIXED" {
        publishDir = [
            [
                path: "${outdir}/out",
                mode: "copy",
                saveAs: { "${meta.Taxon}/${meta.Reference}/5-deaminated/${meta.id}.${meta.Family}.${meta.Species}_deduped_deaminated_1term.bam" },
                pattern: "*1.bam",
            ],
            [
                path: "${outdir}/out",
                mode: "copy",
                saveAs: { "${meta.Taxon}/${meta.Reference}/5-deaminated/${meta.id}.${meta.Family}.${meta.Species}_deduped_deaminated_3term.bam" },
                pattern: "*3.bam",
            ]
        ]
       ext.args = "${params.doublestranded ? 'doublestranded' : ''}"
    }
}